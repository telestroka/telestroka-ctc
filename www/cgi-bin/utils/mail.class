<?php
/***********************************************
-=Ms Site=-

Автор:    Миропольский Михаил <ms@ensk.ru>
Описание: Класс утилит для отправки почты.
***********************************************/
require_once('file.class');

class Mail
{
	function MailDie()
	{
		exit('Произошла внутренняя ошибка. Ошибка отправки почты.');
	}

	function MailMailer($target, $subject, $message)
	{
		$subject = convert_cyr_string($subject, 'w', 'k');
		$message = convert_cyr_string($message, 'w', 'k');
		$from = 'From: mailer@' . $_SERVER['HTTP_HOST'];
		$result = @mail($target, $subject, $message, $from);
		if (!$result) $this->MailDie();

		return TRUE;
	}

	function MailFMailer($target, $subject, $message, $filePath, $fileType, $fileName, $from)
	{
		$subject = convert_cyr_string($subject, 'w', 'k');
		$message = convert_cyr_string($message, 'w', 'k');
		
		$fs = new Fs;

		$content = $fs->FsRead($filePath);
  		$content = chunk_split(base64_encode($content));
  		$uid = strtoupper(md5(uniqid(time())));

		$header = "From: " . $from . "\nReply-To: " . $from . "\n";
		$header .= "MIME-Version: 1.0\n";
		$header .= "Content-Type: multipart/mixed; 
 boundary=\"" . $uid . "\"

This is a multi-part message in MIME format.
";
		$header .= "--" . $uid . "\n";

		$header .= "Content-Type: text/plain\n";
		$header .= "Content-Transfer-Encoding: 8bit\n\n";
		$header .= $message . "\n";
		$header .= "--" . $uid . "\n";

		$header .= "Content-Type: " . $fileType . "; name=\"". $fileName . "\"\n";
		$header .= "Content-Transfer-Encoding: base64\n";
		$header .= "Content-Disposition: attachment;
		filename=\"" . $fileName . "\"\n\n";
		$header .= $content . "\n";

		$header .= "--" . $uid . "--";

		$result = mail($target, $subject, $message, $header);
		if (!$result) $this->MailDie();

		return TRUE;
	}
}
?>