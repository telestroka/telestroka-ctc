<?php
/***********************************************
-=Ms Site=-

Автор: Миропольский Михаил <ms@ensk.ru>
Описание: Класс основного движка
***********************************************/
require_once('vars/vars.class');

class Site extends Vars
{
	function GetParentPage()
	{
		if ( isset($this->PAGES[$this->PAGE]['parent']) )
		return $this->PAGES[$this->PAGES[$this->PAGE]['parent']]['url'];

		return $this->PATH;
	}

	function GetPageFileName()
	{
		$temp = explode("/", $this->PAGES[$this->PAGE]['url']);
		$temp = array_reverse($temp);
		$temp = explode(".", $temp[0]);
		return $temp[0];
	}

	function SiteGoTo($parentPage)
	{
		header('Location: '.$parentPage);
		exit();

		return TRUE;
	}

	function SiteGoToLogin()
	{
		$url = $this->PAGES['login']['url'] . '?from=' . $this->PAGES[$this->PAGE]['url'];
        if (isset($_SERVER['QUERY_STRING']) && $_SERVER['QUERY_STRING'] != '') $url .= '?' . $_SERVER['QUERY_STRING'];
		header('Location: ' . $url);
		exit();

		return TRUE;
	}

	//конструктор
	function Site()
	{
		$this->Vars();

		$this->PATH_DATA = $this->PATH_LOCAL . $this->PATH_DATA;
		$this->PATH_INC = $this->PATH_LOCAL . $this->PATH_INC;
		$this->PATH_IMAGES = $this->PATH_LOCAL . $this->PATH_IMAGES;
		$this->PATH_TEMPLATES = $this->PATH_LOCAL . $this->PATH_TEMPLATES;

		//избавляемся от magic quotes потому что пользуемся собственным слешером
		if (get_magic_quotes_gpc() == 1)
		{
			if ( isset($_POST) && $_SERVER['REQUEST_METHOD'] == 'POST' )
			{
				foreach ($_POST as $key => $value)
				{
					$_POST[$key] = stripslashes($value);
				}
			}

			if ( isset($_GET) && $_SERVER['REQUEST_METHOD'] == 'GET' )
			{
				foreach ($_GET as $key => $value)
				{
					$_GET[$key] = stripslashes($value);
				}
			}
		}

		//Сессии
		if ( !isset($_SESSION) ) session_start();

		//Запрет
        /*
		if ( ($_SERVER["REQUEST_METHOD"] == 'POST' || $_SERVER["QUERY_STRING"]!='') )
		{
			$lock = new Lock;
			if ( $lock->FileIsItemExist($this->PATH_DATA . 'lock.dat', $_SERVER["REMOTE_ADDR"]) || isset($_COOKIE['lock']) )
			{
				if ( !isset($_COOKIE['lock']) ) setcookie('lock', ' ', time()+60*60*24*366);//set cookie for year
				$this->SiteGoTo($this->PAGES['rules_blocker']['url']);
			}
		}
        */
	}
}
?>
