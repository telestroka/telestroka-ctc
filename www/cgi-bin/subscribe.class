<?php
/***********************************************
-=Ms Site=-

Модуль: Subscribe
Автор:    Миропольский Михаил <ms@ensk.ru>
Описание: Класс подписки
***********************************************/

require_once('utils/xmail.class');
require_once('utils/file.class');
require_once('utils/convert.class');

class Subscribe extends File
{
	function SubscribeMail($pathBase, $pathFiles, $subject, $fromName, $from)
	{
		$xmail = new Xmail;
		$emails = $this->FileGetInfo($pathBase);
		if ( count($emails)>0 )
		{
			$images = $this->SubscribeGetImages($pathFiles);
			$files = $this->SubscribeGetFiles($pathFiles);
			$html = $this->FsRead($pathFiles . '/message.html');
			$text = $this->FsRead($pathFiles . '/message.txt');
			$xmail->XmailXmailer($emails, $emails, $subject, $text, $html, $images, $files, $fromName, $from);
		}
	}

	function SubscribeGetImages($path)
	{
		$convert = new Convert;

   		$files = $this->FsReadDir($path);
		$i = 0;
   		foreach ($files as $key => $file)
		{
			if ( strstr($file, 'jpg') || strstr($file, 'gif') )
			{
				$images[$i] = $file; $i++;
			}
		}

		if ( !isset($images) ) return FALSE;
		foreach ($images as $key => $image)
		{
			$images[$key] = $this->FsConvert2Array($image, $path);
		}

		return $images;
	}

	function SubscribeGetFiles($path)
	{
		$convert = new Convert;

   		$files = $this->FsReadDir($path);
		$i=0;
   		foreach ($files as $key => $file)
		{
			if ( strstr($file, 'jpg') ) continue;
			if ( strstr($file, 'gif') ) continue;
			if ( strstr($file, 'htm') ) continue;
			if ( strstr($file, 'txt') ) continue;
			if ( $file == '.' ) continue;
			if ( $file == '..' ) continue;
			$need_files[$i] = $file; $i++;
		}

		if ( !isset($need_files) ) return FALSE;
		foreach ($need_files as $key => $need_file)
		{
			$need_files[$key] = $convert->file2array($need_file, $path);
		}

		return $need_files;
	}
}
?>